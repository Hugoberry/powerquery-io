name: Refresh Power BI documentation and localized files
on: [push]

jobs:
  setup-and-process:
    runs-on: windows-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install Power BI Desktop
        run: choco install --ignore-checksums powerbi

      - name: Process cultures sequentially
        run: |
          $cultures = @('en-US', 'fr-FR') # Add or remove cultures as needed
          foreach ($culture in $cultures) {
            # Set culture-specific environment variable
            $env:PQ_UICultureOverride = $culture

            # Start Power BI Desktop in the appropriate culture
            $pbixPath = Join-Path -Path $env:GITHUB_WORKSPACE -ChildPath "pre-scripts\dox.pbix"
            Start-Process "C:\Program Files\Microsoft Power BI Desktop\bin\PBIDesktop.exe" -ArgumentList $pbixPath
            Start-Sleep -Seconds 60

            # Get the msmdsrv.exe port
            $msmdsrvPorts = Get-Process -Name msmdsrv -ErrorAction SilentlyContinue | ForEach-Object {
              Get-NetTCPConnection -OwningProcess $_.Id | Select-Object LocalPort -Unique
            }
            if ($msmdsrvPorts) {
              # Process the database on the instance for the current culture
              $port = $msmdsrvPorts[0].LocalPort
              $outputJsonFile = "${culture}.json".Replace('-', '')
              pwsh -File ./.github/scripts/generate-doc-output.ps1 -port $port -outputJsonFile $outputJsonFile
            } else {
              Write-Host "No msmdsrv.exe process found."
            }

            # Close Power BI Desktop
            Stop-Process -Name PBIDesktop -Force -ErrorAction SilentlyContinue
            Write-Host "Power BI Desktop closed for culture $culture."

          }
        shell: pwsh
